#!/bin/bash
# Deployer wrapper with secrets management
# Supports three secrets modes:
#   - env-vars:   Direct environment variables (for GitHub Actions CI/CD)
#   - 1password:  1Password CLI integration (deploy/secrets.tpl)
#   - env-file:   Plain .env file (deploy/secrets.env)
# Usage: dep <command> <environment>

set -eo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────

# Find project root (works from any subdirectory)
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/deploy.php" && -f "$dir/composer.json" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

PROJECT_DIR="$(find_project_root)" || {
    echo "Error: Could not find project root (looking for deploy.php)" >&2
    exit 1
}

cd "$PROJECT_DIR"

readonly ENVIRONMENTS="${DEPLOYER_ENVIRONMENTS:-prod staging server}"
readonly PROD_ENVS="${DEPLOYER_PROD_ENVIRONMENTS:-prod staging}"
readonly APP_NAME="${DEPLOYER_APP_NAME:-Application}"

# ─────────────────────────────────────────────────────────────────────────────
# Colors (with fallback for non-interactive terminals)
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]] && [[ "${TERM:-}" != "dumb" ]]; then
    readonly RED='\033[0;31m'
    readonly GREEN='\033[0;32m'
    readonly BLUE='\033[0;34m'
    readonly YELLOW='\033[0;33m'
    readonly NC='\033[0m'
else
    readonly RED='' GREEN='' BLUE='' YELLOW='' NC=''
fi

error() { echo -e "${RED}Error: $*${NC}" >&2; exit 1; }
info() { echo -e "${BLUE}$*${NC}"; }
success() { echo -e "${GREEN}$*${NC}"; }
warn() { echo -e "${YELLOW}$*${NC}"; }

# ─────────────────────────────────────────────────────────────────────────────
# Usage
# ─────────────────────────────────────────────────────────────────────────────

show_usage() {
    cat <<EOF
Usage: dep <command> <environment> [--secrets-mode=MODE]

Environments:
  prod     - Production
  staging  - Staging
  server   - Bootstrap (runs as root)

Secrets modes (auto-detected, or use --secrets-mode):
  env-vars   - Use DEPLOYER_* environment variables directly (CI/CD)
  1password  - Use 1Password CLI with deploy/secrets.tpl
  env-file   - Use plain deploy/secrets.env file

Fresh server setup:
  dep setup:server server && dep setup:environment prod

Regular deploys:
  dep deploy prod
  dep deploy staging

CI/CD deploys (GitHub Actions):
  DEPLOYER_APP_KEY=... DEPLOYER_SUDO_PASS=... dep deploy prod

Multi-environment commands:
  dep caddy:all     - Configure Caddy for all environments
  dep deploy:all    - Deploy to all environments
EOF
    exit 1
}

# ─────────────────────────────────────────────────────────────────────────────
# Detect Secrets Mode
# Priority: explicit flag > env-vars > 1password > env-file
# ─────────────────────────────────────────────────────────────────────────────

SECRETS_MODE=""
SECRETS_FILE=""
EXPLICIT_MODE=""

# Check for explicit --secrets-mode flag
for arg in "$@"; do
    if [[ "$arg" == --secrets-mode=* ]]; then
        EXPLICIT_MODE="${arg#--secrets-mode=}"
    fi
done

# Function to check if required env vars are set (for CI/CD mode)
check_env_vars_mode() {
    # Required: at least DEPLOYER_SUDO_PASS and DEPLOYER_APP_KEY must be set
    [[ -n "${DEPLOYER_SUDO_PASS:-}" && -n "${DEPLOYER_APP_KEY:-}" ]]
}

if [[ -n "$EXPLICIT_MODE" ]]; then
    # Explicit mode specified
    case "$EXPLICIT_MODE" in
        env-vars)
            if ! check_env_vars_mode; then
                error "env-vars mode requires DEPLOYER_SUDO_PASS and DEPLOYER_APP_KEY environment variables."
            fi
            SECRETS_MODE="env-vars"
            ;;
        1password)
            if [[ ! -f "deploy/secrets.tpl" ]]; then
                error "1password mode requires deploy/secrets.tpl file."
            fi
            SECRETS_MODE="1password"
            SECRETS_FILE="deploy/secrets.tpl"
            ;;
        env-file)
            if [[ ! -f "deploy/secrets.env" ]]; then
                error "env-file mode requires deploy/secrets.env file."
            fi
            SECRETS_MODE="env-file"
            SECRETS_FILE="deploy/secrets.env"
            ;;
        *)
            error "Unknown secrets mode: $EXPLICIT_MODE\nValid modes: env-vars, 1password, env-file"
            ;;
    esac
elif check_env_vars_mode; then
    # Auto-detect: env-vars mode (CI/CD - environment variables already set)
    SECRETS_MODE="env-vars"
elif [[ -f "deploy/secrets.tpl" && -f "deploy/secrets.env" ]]; then
    error "Both deploy/secrets.tpl and deploy/secrets.env exist.\nRemove one to resolve the conflict, or use --secrets-mode flag."
elif [[ -f "deploy/secrets.tpl" ]]; then
    SECRETS_MODE="1password"
    SECRETS_FILE="deploy/secrets.tpl"
elif [[ -f "deploy/secrets.env" ]]; then
    SECRETS_MODE="env-file"
    SECRETS_FILE="deploy/secrets.env"
else
    error "No secrets configuration found.\nOptions:\n  1. Set DEPLOYER_SUDO_PASS and DEPLOYER_APP_KEY env vars (CI/CD)\n  2. Create deploy/secrets.tpl (1Password)\n  3. Create deploy/secrets.env (plain file)\n\nRun 'vendor/bin/dep init' to set up your project."
fi

# ─────────────────────────────────────────────────────────────────────────────
# Parse Arguments
# ─────────────────────────────────────────────────────────────────────────────

ENV=""
COMMAND=""
ARGS=()

for arg in "$@"; do
    for env in $ENVIRONMENTS; do
        if [[ "$arg" == "$env" ]]; then
            ENV="$arg"
            break
        fi
    done
    if [[ -z "$COMMAND" && "$arg" != -* ]]; then
        COMMAND="$arg"
    fi
    ARGS+=("$arg")
done

# Handle multi-environment commands
if [[ "$COMMAND" == "caddy:all" || "$COMMAND" == "deploy:all" ]]; then
    ENV="all"
fi

[[ -z "$ENV" ]] && show_usage

# ─────────────────────────────────────────────────────────────────────────────
# Validate Prerequisites
# ─────────────────────────────────────────────────────────────────────────────

[[ -f "vendor/bin/dep" ]] || error "Deployer not installed. Run: composer install"

if [[ "$SECRETS_MODE" == "1password" ]]; then
    if ! command -v op >/dev/null 2>&1; then
        warn "1Password CLI (op) not installed."
        warn "Install: brew install 1password-cli"
        warn ""
        warn "Alternatives:"
        warn "  - Set DEPLOYER_SUDO_PASS and DEPLOYER_APP_KEY env vars (CI/CD mode)"
        warn "  - Create deploy/secrets.env (plain file mode)"
        error "Cannot continue in 1password mode without 'op' CLI."
    fi
fi

# GitHub CLI is optional - warn but don't fail
if ! command -v gh >/dev/null 2>&1; then
    warn "GitHub CLI (gh) not installed. Some features may not work."
    warn "Install with: brew install gh"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Authenticate
# ─────────────────────────────────────────────────────────────────────────────

if [[ "$SECRETS_MODE" == "1password" ]]; then
    if ! op account list &>/dev/null 2>&1; then
        info "Signing in to 1Password..."
        eval "$(op signin)"
    fi
fi

if command -v gh >/dev/null 2>&1; then
    if ! gh auth status &>/dev/null 2>&1; then
        info "Authenticating with GitHub..."
        gh auth login
    fi
fi

# ─────────────────────────────────────────────────────────────────────────────
# Set Environment
# ─────────────────────────────────────────────────────────────────────────────

DEPLOYER_ENV="$ENV"
[[ "$ENV" == "server" || "$ENV" == "all" ]] && DEPLOYER_ENV="prod"

export DEPLOYER_ENV
info "Environment: $DEPLOYER_ENV"
info "Secrets mode: $SECRETS_MODE"

# ─────────────────────────────────────────────────────────────────────────────
# Run Deployer
# ─────────────────────────────────────────────────────────────────────────────

run_deployer() {
    # Filter out --secrets-mode flag from arguments
    local filtered_args=()
    for arg in "$@"; do
        if [[ "$arg" != --secrets-mode=* ]]; then
            filtered_args+=("$arg")
        fi
    done

    case "$SECRETS_MODE" in
        env-vars)
            # CI/CD mode: secrets are already in environment
            vendor/bin/dep "${filtered_args[@]}"
            ;;
        1password)
            op run --cache=false --env-file="$SECRETS_FILE" -- vendor/bin/dep "${filtered_args[@]}"
            ;;
        env-file)
            # Source env file and run deployer
            set -a
            source "$SECRETS_FILE"
            set +a
            vendor/bin/dep "${filtered_args[@]}"
            ;;
    esac
}

case "$COMMAND" in
    caddy:all)
        i=1
        total=$(echo $PROD_ENVS | wc -w | tr -d ' ')
        for env in $PROD_ENVS; do
            success "[$i/$total] Configuring Caddy for $env..."
            run_deployer caddy:configure "$env" -v
            echo ""
            ((i++))
        done
        success "Caddy configured for all environments"
        ;;
    deploy:all)
        i=1
        total=$(echo $PROD_ENVS | wc -w | tr -d ' ')
        for env in $PROD_ENVS; do
            success "[$i/$total] Deploying $env..."
            run_deployer deploy "$env" -v
            echo ""
            ((i++))
        done
        success "Deployed to all environments"
        ;;
    *)
        run_deployer "${ARGS[@]}"
        ;;
esac
