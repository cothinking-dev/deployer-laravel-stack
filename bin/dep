#!/bin/bash
# Deployer wrapper with 1Password integration
# Usage: dep <command> <environment>

set -eo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────

# Find project root (works from any subdirectory)
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/deploy.php" && -f "$dir/composer.json" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

PROJECT_DIR="$(find_project_root)" || {
    echo "Error: Could not find project root (looking for deploy.php)" >&2
    exit 1
}

cd "$PROJECT_DIR"

readonly SECRETS_FILE="${DEPLOYER_SECRETS_FILE:-deploy/secrets.tpl}"
readonly ENVIRONMENTS="${DEPLOYER_ENVIRONMENTS:-prod staging server}"
readonly PROD_ENVS="${DEPLOYER_PROD_ENVIRONMENTS:-prod staging}"
readonly APP_NAME="${DEPLOYER_APP_NAME:-Application}"

# ─────────────────────────────────────────────────────────────────────────────
# Colors (with fallback for non-interactive terminals)
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]] && [[ "${TERM:-}" != "dumb" ]]; then
    readonly RED='\033[0;31m'
    readonly GREEN='\033[0;32m'
    readonly BLUE='\033[0;34m'
    readonly YELLOW='\033[0;33m'
    readonly NC='\033[0m'
else
    readonly RED='' GREEN='' BLUE='' YELLOW='' NC=''
fi

error() { echo -e "${RED}Error: $*${NC}" >&2; exit 1; }
info() { echo -e "${BLUE}$*${NC}"; }
success() { echo -e "${GREEN}$*${NC}"; }
warn() { echo -e "${YELLOW}$*${NC}"; }

# ─────────────────────────────────────────────────────────────────────────────
# Usage
# ─────────────────────────────────────────────────────────────────────────────

show_usage() {
    cat <<EOF
Usage: dep <command> <environment>

Environments:
  prod     - Production
  staging  - Staging
  server   - Bootstrap (runs as root)

Fresh server setup:
  dep setup:server server && dep setup:environment prod

Regular deploys:
  dep deploy prod
  dep deploy staging

Multi-environment commands:
  dep caddy:all     - Configure Caddy for all environments
  dep deploy:all    - Deploy to all environments
EOF
    exit 1
}

# ─────────────────────────────────────────────────────────────────────────────
# Parse Arguments
# ─────────────────────────────────────────────────────────────────────────────

ENV=""
COMMAND=""
ARGS=()

for arg in "$@"; do
    for env in $ENVIRONMENTS; do
        if [[ "$arg" == "$env" ]]; then
            ENV="$arg"
            break
        fi
    done
    if [[ -z "$COMMAND" && "$arg" != -* ]]; then
        COMMAND="$arg"
    fi
    ARGS+=("$arg")
done

# Handle multi-environment commands
if [[ "$COMMAND" == "caddy:all" || "$COMMAND" == "deploy:all" ]]; then
    ENV="all"
fi

[[ -z "$ENV" ]] && show_usage

# ─────────────────────────────────────────────────────────────────────────────
# Validate Prerequisites
# ─────────────────────────────────────────────────────────────────────────────

[[ -f "$SECRETS_FILE" ]] || error "Secrets file not found: $SECRETS_FILE"
[[ -f "vendor/bin/dep" ]] || error "Deployer not installed. Run: composer install"

command -v op >/dev/null 2>&1 || error "1Password CLI (op) not installed.\nInstall: brew install 1password-cli"
command -v gh >/dev/null 2>&1 || error "GitHub CLI (gh) not installed.\nInstall: brew install gh"

# ─────────────────────────────────────────────────────────────────────────────
# Authenticate
# ─────────────────────────────────────────────────────────────────────────────

if ! op account list &>/dev/null 2>&1; then
    info "Signing in to 1Password..."
    eval "$(op signin)"
fi

if ! gh auth status &>/dev/null 2>&1; then
    info "Authenticating with GitHub..."
    gh auth login
fi

# ─────────────────────────────────────────────────────────────────────────────
# Set Environment
# ─────────────────────────────────────────────────────────────────────────────

DEPLOYER_ENV="$ENV"
[[ "$ENV" == "server" || "$ENV" == "all" ]] && DEPLOYER_ENV="prod"

export DEPLOYER_ENV
info "Environment: $DEPLOYER_ENV"

# ─────────────────────────────────────────────────────────────────────────────
# Run Deployer
# ─────────────────────────────────────────────────────────────────────────────

run_deployer() {
    op run --cache=false --env-file="$SECRETS_FILE" -- vendor/bin/dep "$@"
}

case "$COMMAND" in
    caddy:all)
        i=1
        total=$(echo $PROD_ENVS | wc -w | tr -d ' ')
        for env in $PROD_ENVS; do
            success "[$i/$total] Configuring Caddy for $env..."
            run_deployer caddy:configure "$env" -v
            echo ""
            ((i++))
        done
        success "Caddy configured for all environments"
        ;;
    deploy:all)
        i=1
        total=$(echo $PROD_ENVS | wc -w | tr -d ' ')
        for env in $PROD_ENVS; do
            success "[$i/$total] Deploying $env..."
            run_deployer deploy "$env" -v
            echo ""
            ((i++))
        done
        success "Deployed to all environments"
        ;;
    *)
        run_deployer "${ARGS[@]}"
        ;;
esac
